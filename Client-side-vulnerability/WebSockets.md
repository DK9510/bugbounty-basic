# Testing WebSockets vulnerabilities
 # WebSockets
 - it is widely used in modern web applications, they initiated over HTTP and provide long-lived connections with asynchronous communication in both directions
 - web sockets are used for all kinds of purposes, including performing `user action`, `Transmitting sensitive info` etc
 - Virtually any web security vulnerability that arise with regular HTTP can also arise in relation to `WebSockets communication`
## What are WebSockets
- WebSockets are bi-directional, full duplex communication protocol initiated over HTTP.
- they are commonly used in modern web application for Streaming data & other asynchronous traffic.
![image](https://github.com/DK9510/Images/blob/main/img_web_socket.png)

## Different between WebSockets and HTTP
- Most communication between web browsers and web servers uses `HTTP`, with HTTP client sends the request and the server returns a response.
- Typically a response occurs immediately and transaction is complete, even if the network connection stays open, this will be used for a separate transaction of a request and response.
- some modern web site use `WebSockets`, this connections are initiated over HTTP and typically long lived.
- message can be send in either direction at any time and are no transactional in nature, and the connection stay open and idle until any of client or server is ready to send a message.
- `WebSockets` perticularly useful in situation where `low-latency` or `sever-initiated message ` are required, example: 	`real-time feeds` and `financial data`

## How WebSocket connections Established
- it normally created using client-side`JavaScript`
- `var ws = new WebSocket("wss://normal-web.com/chats");`
- `Note:` the `wss` protocol establish WebSocket over Encrypted TLS connection while `Ws` uses an Unencrypted connection.
### For Establishing connection Browser and server Perform WebSocket handshake over HTTP
request from browser
```JS
GET /chat HTTP/1.1
Host: normal-web.com
Sec-WebSocket-Version: 13
Sec-WebSocket-Key= esdfbvhwlb4byrf3weir==
Connection: keep-alive, upgrade
Cookie: session=dfhvbk4w5byrh348ryf3
Upgrade: websocket
```
and server accept the connection and responded
```JS
HTTP/1.1 101 Switching Protocols
Connection: Upgrade
Upgrade: websocket
Sec-WebSocket-Accept: sceurcoiaunU_0hahn==
```
at this point Network Connections remains open and can be used to send `WebSocket` messages in either direction

## Whatdo websocket mssage look like
- simple message sent from the browser using client side jS
- ` ws.send("DK 9510");`
- a websocket can contain any content or data format, in modern application it is commonly used `JSON` to send structured data within websocket message
- `example:` chat bot
`{"user": "DK9510", "content": "hey welcome to the DK's World"}`

# Manipulating WebSocket traffic
- intercepting and modifying WebSocket messages
- Replay and generate new WebSocket message
- Manipulate WebSocket connections

## Intercepting and Modifying WebSocket message
we use `Burp Proxy` to intercept and modify Websocket message as follow
- Configure your browser to use Brup suite as Proxy server
- Browse the application function that uses Websockets, we determine that websockets are beings used by using the application and looking for entries appearing in the `websocket history` ta
- in `intercept` tab turn on intercept
- when a websocket message is sent from the browser or server it will display in the `intercept` tab and we view and modify 
###[How to configure WebSocket in burpsuite pro](https://portswigger.net/burp/documentation/desktop/tools/proxy/options#intercepting-websocket-messages)

## Replaying and Generating New WebSocket message
- after intersept in burpsuite we send this request to `repeater`
- if we want to edit or resend any message, go to `websocket history` select message and choose `Edit and resend` from context menu.

## manipulation WebSocket Connections
it necessary to manipulate the `websocket handshake` that establish the connection
 some situation where manipulating `handshake` is necessary
 - it can enable us to reach more attack surface
 - some attacks might cause to Drop our connection , so we need to establish new one
 - Token or other data in the original `handshake` request might be stale and need updating
we manipulate it using `Burp Repeater`
- send WebSocket message to `burp repeater`,
- click on the pencil icon next to `websocket URL`, this open wizard that lets us to attach to an `existing connected WebSocket` clone a connected websocket or reconnect to a disconnected websocket.
- if we choose to `clone or reconnect` to disconnected Websocket than wizard show full details of the `websocaket request` which we can edit as required before the handshake is performed.
- when click `Connect` , burp will attempt to carry out the configured handshake and display the result, if a new websocket connection was successfully established, you can then use this to send new messages in burp Repeater
- we use this to send new message in `Burp repeater`

# WebSocket security Vulnerabilities
- user-supplied input transmitted to the server might be processed in unsafe ways, leading to vulnerabilities such as `SQL injection` or `XML external entity injection`
- some `Blind` vulnerabilities reached via `WebSockets` might only be detectable using `Out-of-band(OAST) technique`
- if attacker-controlled data is transmitted via Websockets to other Application users, then it might lead to `Client-side vulerabilities`

## Manipulate WebSocket message to exploit Vulnerabilities
- majority of input-based vulnerabilities affecting websockets can be found and exploited by `tampering with the contentes of WebSocket message`
- `exmple:` chat application uses websocket send chats between the browser and server.
`{"message": "hello DK"}`
the contents of the message are transmitted via websocket to another chat user, and rendered in the user's browser as follow
`<td>hello DK</td>`
in this situation provide another input processing or defense are in play, an attacker can perform a proof-pf-concept `XSS` attack by submitting `Websocket message`
`{"message": "<img src= 1 onerror='alert(0)'>"}`

## Manipulate WebSocket handshake to Exploit Vulnerabilities
some Websocket vulnerabilities can only be found and exploited by `Manipulating WebSocket handshake` , these vulnerabilities tend to involve design flows such as
- Misplaced trust in HTTP headers to perform security decisions such as `X-Forwarded-For` header.
- Flaws in session handling mechanisms, since the session context in which websocket messages are processed is generally determined by the session context of the handshake message.
- Attack Surface introduced by custom HTTP headers used by the application
- `example lab protswigger`[lab](https://portswigger.net/web-security/websockets/lab-manipulating-handshake-to-exploit-vulnerabilities)
- `Note:` if server blocks our ip by inputing malicious content then we customize `header` in the `websocket handshake` like `X-Forwarded-For: custom ip`

## Using Cross-Site WebSockets to exploit Vulnerabilities
- some websocket security vulnerabilities arise when an attacker makes a `cross-domain` websocket connection form a web site that the attacker controls.
- also known as `Cross site websocket hijacking` and also it involves `CSRF` vulnerabilities on a websocket handshake. 
- The attack often has a serious impact, allowing an attacker to perform privileged actions on behalf of the victim user or capture sensitive data to which the victim user has access

# Cross-site WebSocket Hijacking
## what is cross-site websocket hijacking 
- Cross-site websocket hijacking also known as `Cross-origin websocket hijacking`
- it involves an `CSRF` vulnerability on a websocket handshake, 
- it arise when when the websocket handshake request relies solely on HTTP cookies for session handling and does not contain any `CSRF Tokens` other unpredictable values.
- `example:`
- An attacker can create a malicious web page on their own domain which establishes a cross-site WebSocket connection to the vulnerable application. The application will handle the connection in the context of the victim user's session with the application.
- The attacker's page can then send arbitrary messages to the server via the connection and read the contents of messages that are received back from the server. This means that, unlike regular CSRF, the attacker gains two-way interaction with the compromised application

## Impact of Cross-site Websocket hijacking 
- **Perform Unauthorized actions masquerading as the victim user:** as with regular `CSRF attack` the attacker can send arbitrary to the server-side application. if the application uses client-generated websocket messages to perform any sensitive action, then the attacker can generate suitable messages cross-domain and trigger those actions.
- **Retrieve Sensitive data that the user can access:** Unlike with regular `CSRF` ,	`cross-site websocket hijacking` gives the attacker two-way interaction with the vulnerable application over the hijacked websocket. if the application uses `server-generated websocket messages` to return any sensitive data to the user, then the attacker can intercept those messages and capture the victim user's data.

## Cross-site websocket hijacking attack
- it is a `CSRF `vulnerability on websocket handshake, 
- 1 st step is for performing attack is review websocket handshake that application carries out and determine whether they are `protected against CSRF`
-  a handshake message that relies solely on HTTP cookies for session handling and doesn't employ any tokens or other unpredictable values in request parameters. `than this is most probabiliy vulnerable to CSRF`
-  `example:`
```js
GET /chat HTTP/1.1
Host: normal-web.com
Sec-WebSocket-Version: 13
Sec=WebSocket-Key: wkqdmtseNBJdhkihL6PW7w==
Connection: keep-alive, Upgrade
Cookie: session=ebvhw4ie5yrb3ieyrhofl4wei
Upgrade: websocket
```
this is vulnerable to `CSRF` as only session cookie is added not any CSRF tokens are included
`Note:` the `Sec-WebSoket-Key` header contains a random value to prevent errors from caching proxies, and is not used for authentication or session handling purposes.

if `Websocket handshake` request is vulnerable to `CSRF` then an attacker's web page can perform a cross-site request to open a `websocket` on the vulnerable site.
- next what happens depend on application's logic and attacker 
	-   Sending WebSocket messages to perform unauthorized actions on behalf of the victim user.
	- Sending WebSocket messages to retrieve sensitive data.
	- Sometimes, just waiting for incoming messages to arrive containing sensitive data.

`exmple lab portswigger` [lab](https://portswigger.net/web-security/websockets/cross-site-websocket-hijacking/lab)

## How to secure a WebSocket connection
-   Use the `wss://` protocol (WebSockets over TLS).
-   Hard code the URL of the WebSockets endpoint, and certainly don't incorporate user-controllable data into this URL.
-   Protect the WebSocket handshake message against CSRF, to avoid cross-site WebSockets hijacking vulnerabilities.
-   Treat data received via the WebSocket as untrusted in both directions. Handle data safely on both the server and client ends, to prevent input-based vulnerabilities such as SQL injection and [cross-site scripting](https://portswigger.net/web-security/cross-site-scripting).
